---
- name: Check for existing Xcode installation
  ansible.builtin.stat:
    path: "/Applications/Xcode_{{ xcode_version }}.app"
  register: xcode_app

- name: "Download XCode {{ xcode_version }}"
  ansible.builtin.shell: >
    jfrog rt dl
    --flat
    --fail-no-op
    --retries=100
    "--url=https://artifactory.ccdc.cam.ac.uk/artifactory"
    "--user={{ ansible_deployment_artifactory_user }}"
    "--password={{ ansible_deployment_artifactory_key }}"
    "ccdc-3rdparty-macos-xcode-installers/Xcode_{{ xcode_version }}.xip"
    ~/Downloads/
  environment:
    PATH: "/usr/local/bin:/usr/bin"
    CI: "true"
    JFROG_CLI_OFFER_CONFIG: "false"
  when: xcode_app.stat.isdir is not defined or not xcode_app.stat.isdir
  register: download
  args:
    creates: "~/Downloads/Xcode_{{ xcode_version }}.xip"

- name: Extract XCode archive
  ansible.builtin.command: xip -x ~/Downloads/Xcode_{{ xcode_version }}.xip
  args:
    chdir: "/Applications"
    creates: "/Applications/Xcode.app"
  when: xcode_app.stat.isdir is not defined or not xcode_app.stat.isdir
  register: extract_xcode_xip

- name: Move XCode to /Applications/Xcode_{{ xcode_version }}.app # noqa: name[template]
  ansible.builtin.command: mv /Applications/Xcode.app /Applications/Xcode_{{ xcode_version }}.app
  when: xcode_app.stat.isdir is not defined or not xcode_app.stat.isdir
  args:
    creates: "/Applications/Xcode_{{ xcode_version }}.app"

- name: Remove downloaded Xcode archive
  ansible.builtin.file:
    state: absent
    path: "~/Downloads/Xcode_{{ xcode_version }}.xip"

- name: Switch to /Applications/Xcode_{{ xcode_version }}.app # noqa: no-changed-when name[template]
  ansible.builtin.command: xcode-select --switch /Applications/Xcode_{{ xcode_version }}.app/Contents/Developer
  become: true

- name: Accept Xcode licence # noqa: no-changed-when
  ansible.builtin.command: xcodebuild -license accept
  become: true

- name: Get list of installed packages # noqa: no-changed-when
  ansible.builtin.command: pkgutil --pkgs
  register: pkgutil_packages

- name: Get list of packages available with Xcode
  ansible.builtin.find:
    path: /Applications/Xcode_{{ xcode_version }}.app/Contents/Resources/Packages/
    patterns: "*.pkg"
    recurse: no
  register: packages

- name: Install Xcode packages # noqa: deprecated-module
  ansible.builtin.include: install-pkg.yml
  vars:
    package_file: "{{ package }}"
    package_list: "{{ pkgutil_packages.stdout }}"
  with_items: "{{ packages.files | map(attribute='path') | list }}"
  loop_control:
    loop_var: package
