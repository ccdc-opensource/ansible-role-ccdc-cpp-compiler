---
- name: Check XCode app present
  stat:
    path: /Applications/Xcode.app
  register: xcode_app

- name: Download XCode
  get_url:
    url: "{{ xcode_xip_url }}"
    dest: ~/Downloads/xcode.xip
    mode: '0440'
  when: xcode_app.stat.isdir is not defined or not xcode_app.stat.isdir

- name: Extract XCode archive
  command: xip -x ~/Downloads/xcode.xip
  args:
    chdir: "/Applications"
    creates: "/Applications/Xcode.app"
  register: extract_xcode_xip

- name: Accept Xcode licence
  command: xcodebuild -license accept
  become: true

- name: get list of installed packages
  command: pkgutil --pkgs
  register: pkgutil_packages

- name: get list of packages in XCode
  find:
    path: /Applications/Xcode.app/Contents/Resources/Packages/
    patterns: '*.pkg'
    recurse: no
  register: packages

- name: add xcode package
  include: install-pkg.yml
  vars:
    package_file: "{{ item }}"
    package_list: "{{ pkgutil_packages.stdout }}"
  with_items: "{{ packages.files | map(attribute='path') | list }}"

- name: Clean downloaded xcode
  file:
    state: absent
    path: ~/Downloads/xcode.xip